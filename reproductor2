<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor YouTube Overlay - Mejorado con Apple Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            overflow: hidden;
            position: relative;
        }

        /* Contenedor principal */
        .youtube-overlay-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Iframe de YouTube de fondo */
        .youtube-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            z-index: 1;
        }

        /* Capa de overlay */
        .overlay-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.05);
            z-index: 2;
            display: flex;
            flex-direction: column;
            pointer-events: none; /* Permite clicks a trav√©s de √°reas vac√≠as si es necesario */
        }
        
        /* Reactivar puntero para controles */
        .top-controls, .bottom-controls {
            pointer-events: auto;
        }

        /* Controles superiores */
        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: linear-gradient(180deg, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0) 100%);
            height: 100px;
        }

        .logo {
            color: #FF0000;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .video-info {
            color: white;
            text-align: center;
            flex: 1;
        }

        .video-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .video-range {
            font-size: 14px;
            color: #FF6B6B;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            font-weight: bold; /* Estilo para el contador de tiempo */
        }

        .control-buttons {
            display: flex;
            gap: 15px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .control-btn.primary {
            background: linear-gradient(45deg, #FF0000, #FF6B6B);
            border: none;
            font-weight: bold;
            padding: 12px 24px;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .control-btn.primary:hover {
            background: linear-gradient(45deg, #FF3333, #FF8888);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.4);
        }

        /* Selector de resoluci√≥n */
        .resolution-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 15px;
        }

        .resolution-label {
            color: white;
            font-size: 14px;
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            white-space: nowrap;
        }

        .quality-select {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
            min-width: 120px;
        }

        .quality-select:hover {
            border-color: rgba(255, 107, 107, 0.6);
            background: rgba(255, 255, 255, 0.25);
        }

        .quality-select:focus {
            border-color: #FF6B6B;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.2);
        }

        .quality-select option {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
        }

        /* Controles inferiores mejorados */
        .bottom-controls {
            padding: 20px;
            background: linear-gradient(0deg, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0) 100%);
            margin-top: auto; /* Empuja hacia abajo */
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Timeline wrapper estilo Apple */
        .timeline-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            opacity: 0.5;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .timeline-wrapper.active {
            opacity: 1;
            pointer-events: auto;
        }

        .timeline-scroll-area {
            flex-grow: 1;
            overflow-x: auto;
            overflow-y: hidden;
            position: relative;
            height: 40px;
            border-radius: 4px;
            background: rgba(255,255,255,0.05);
            scrollbar-width: thin;
            scrollbar-color: #555 #222;
        }

        /* Contenedor de progreso mejorado */
        .progress-container {
            position: relative;
            height: 100%;
            width: 100%;
            cursor: crosshair;
            background: repeating-linear-gradient(
                90deg,
                rgba(255,255,255,0.1) 0px,
                rgba(255,255,255,0.1) 1px,
                transparent 1px,
                transparent 20px
            );
            transition: width 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Barra de progreso rellena */
        .progress-bar-fill {
            background: rgba(255, 0, 0, 0.3);
            height: 100%;
            width: 0%;
            pointer-events: none;
        }

        /* El cabezal de reproducci√≥n (Playhead) estilo Apple */
        .playhead {
            position: absolute;
            top: 0;
            left: 0%;
            width: 2px;
            height: 100%;
            background-color: #FF0000;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
            z-index: 10;
            pointer-events: none;
            transition: left 0.05s linear;
        }

        .playhead::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -6px;
            width: 0;
            height: 0;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-top: 8px solid #FF0000;
        }

        /* Controles de Zoom estilo Apple */
        .zoom-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .zoom-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
        }

        .zoom-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Rango inputs mejorados */
        .range-inputs {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            margin-top: 20px;
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5;
            pointer-events: auto;
        }

        .play-range-section {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 25px;
            border-radius: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .time-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .time-input {
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            width: 80px;
            text-align: center;
            outline: none;
            font-family: monospace;
        }

        .time-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .time-label {
            color: #FF6B6B;
            font-weight: bold;
            font-size: 14px;
        }

        /* Panel de configuraci√≥n (oculto inicialmente) */
        .config-panel, .effects-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            z-index: 9999; /* Z-Index muy alto */
            display: none;
            min-width: 450px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }

        .config-panel.show,
        .effects-panel.show {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            gap: 20px !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .config-panel h3 {
            color: #FF6B6B;
            margin-bottom: 20px;
            text-align: center;
        }

        .url-input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .url-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 10000;
            border-left: 4px solid #FF0000;
            display: none;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Estilos de paneles y efectos (mantenidos igual) */
        .effects-panel h3 { color: #FF6B6B; margin-bottom: 25px; text-align: center; font-size: 22px; }
        .effects-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 25px; margin-bottom: 25px; width: 100%; }
        .effect-control { display: flex; flex-direction: column; gap: 10px; }
        .effect-control label { color: #FF6B6B; font-weight: bold; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .effect-value { background: rgba(255, 255, 255, 0.2); padding: 2px 8px; border-radius: 12px; font-size: 12px; min-width: 50px; text-align: center; }
        .effect-slider { width: 100%; height: 6px; border-radius: 3px; background: rgba(255, 255, 255, 0.3); outline: none; -webkit-appearance: none; transition: all 0.3s ease; }
        .effect-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: linear-gradient(45deg, #FF0000, #FF6B6B); cursor: pointer; border: 2px solid white; box-shadow: 0 2px 8px rgba(255, 0, 0, 0.3); }
        .effects-actions { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        
        /* Resto de estilos para presets, senior effects, etc. */
        .preset-effects { margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.2); width: 100%; }
        .preset-effects h4 { color: #FF6B6B; margin-bottom: 15px; text-align: center; font-size: 14px; font-weight: normal; }
        .preset-buttons { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        .preset-btn { background: rgba(255, 107, 107, 0.2); border: 2px solid rgba(255, 107, 107, 0.4); color: white; padding: 12px 16px; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-size: 14px; backdrop-filter: blur(10px); min-width: 140px; justify-content: center; }
        .preset-btn:hover { background: rgba(255, 107, 107, 0.3); border-color: rgba(255, 107, 107, 0.6); transform: translateY(-2px); }
        .preset-btn.active { background: rgba(255, 107, 107, 0.4); border-color: #FF6B6B; box-shadow: 0 0 15px rgba(255, 107, 107, 0.3); }
        .advanced-effects { margin: 25px 0; padding: 25px 0; border-top: 1px solid rgba(255, 255, 255, 0.1); width: 100%; }
        .advanced-effects h4 { color: #FFD700; margin-bottom: 20px; text-align: center; font-size: 16px; font-weight: normal; }
        .genre-presets { margin: 25px 0; padding: 25px 0; border-top: 1px solid rgba(255, 255, 255, 0.1); width: 100%; }
        .genre-presets h4 { color: #00BFFF; margin-bottom: 20px; text-align: center; font-size: 16px; font-weight: normal; }
        .senior-effects { margin: 30px 0; padding: 30px 0; border-top: 2px solid; border-image: linear-gradient(90deg, #FF6B35, #F7931E, #FFD700, #F7931E, #FF6B35) 1; background: linear-gradient(135deg, rgba(255, 107, 53, 0.05), rgba(247, 147, 30, 0.05), rgba(255, 215, 0, 0.05)); border-radius: 15px; width: 100%; }
        .senior-effects h4 { background: linear-gradient(45deg, #FF6B35, #F7931E, #FFD700, #F7931E, #FF6B35); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 25px; text-align: center; font-size: 18px; font-weight: bold; letter-spacing: 2px; }
        .genre-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .genre-btn { background: rgba(0, 191, 255, 0.15); border: 2px solid rgba(0, 191, 255, 0.3); color: white; padding: 15px 12px; border-radius: 15px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; text-align: center; font-weight: 500; display: flex; flex-direction: column; align-items: center; gap: 5px; backdrop-filter: blur(10px); }
        .genre-btn:hover { background: rgba(0, 191, 255, 0.25); border-color: rgba(0, 191, 255, 0.5); transform: translateY(-2px); }
        .genre-icon { font-size: 20px; margin-bottom: 2px; }
    </style>
</head>
<body>
    <div class="youtube-overlay-container">
        <iframe id="youtubeBackground" 
                class="youtube-background"
                src="" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
                allowfullscreen>
        </iframe>

        <div class="overlay-layer" id="overlayLayer">
            <div class="top-controls">
                <div class="logo">YT RANGE</div>
                
                <div class="video-info">
                    <div class="video-title" id="videoTitle">YouTube Range Player</div>
                    <div class="video-range" id="videoRange">Selecciona un video</div>
                </div>
                
                <div class="control-buttons">
                    <button class="control-btn" id="configBtn">‚öôÔ∏è Configurar</button>
                    <button class="control-btn" id="effectsBtn">üé® Efectos</button>
                    <button class="control-btn" id="fullscreenBtn">üî≥ Pantalla Completa</button>
                    
                    <div class="resolution-selector">
                        <label for="videoQuality" class="resolution-label">üì∫ Calidad:</label>
                        <select class="quality-select" id="videoQuality">
                            <option value="auto" selected>Auto</option>
                            <option value="hd1080">1080p HD</option>
                            <option value="hd720">720p HD</option>
                            <option value="medium">480p</option>
                            <option value="small">360p</option>
                            <option value="tiny">240p</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="bottom-controls">
                <!-- Timeline wrapper estilo Apple -->
                <div class="timeline-wrapper" id="timelineWrapper">
                    <div class="zoom-controls">
                        <button class="zoom-btn" id="zoomOutBtn">üîç-</button>
                        <button class="zoom-btn" id="zoomInBtn">üîç+</button>
                    </div>

                    <div class="timeline-scroll-area" id="timelineScrollArea">
                        <div class="progress-container" id="progressContainer">
                            <div class="progress-bar-fill" id="progressBarFill"></div>
                            <div class="playhead" id="playhead"></div>
                        </div>
                    </div>
                </div>
                
                <div class="range-inputs">
                    <div class="time-input-group">
                        <span class="time-label">Desde:</span>
                        <input type="text" class="time-input" id="startTime" value="0:00" placeholder="0:00">
                    </div>
                    
                    <div class="play-range-section">
                        <button class="control-btn primary" id="playRangeBtn">‚ñ∂Ô∏è CARGAR RANGO</button>
                    </div>
                    
                    <div class="time-input-group">
                        <span class="time-label">Hasta:</span>
                        <input type="text" class="time-input" id="endTime" value="--:--" placeholder="--:--">
                    </div>
                </div>
            </div>
        </div>

        <div class="config-panel" id="configPanel">
            <h3>‚öôÔ∏è Configurar Video</h3>
            <input type="text" class="url-input" id="videoUrl" placeholder="Pega la URL de YouTube aqu√≠">
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="control-btn" id="cancelConfig">Cancelar</button>
                <button class="control-btn primary" id="loadVideo">Cargar Video</button>
            </div>
        </div>

        <div class="effects-panel" id="effectsPanel">
            <h3>üé® Efectos de Video</h3>
            
            <div class="effects-grid">
                <div class="effect-control">
                    <label><span>Brillo</span><span class="effect-value" id="brightnessValue">100%</span></label>
                    <input type="range" class="effect-slider" id="brightness" min="0" max="200" value="100">
                </div>
                <div class="effect-control">
                    <label><span>Contraste</span><span class="effect-value" id="contrastValue">100%</span></label>
                    <input type="range" class="effect-slider" id="contrast" min="0" max="200" value="100">
                </div>
                <div class="effect-control">
                    <label><span>Saturaci√≥n</span><span class="effect-value" id="saturateValue">100%</span></label>
                    <input type="range" class="effect-slider" id="saturate" min="0" max="200" value="100">
                </div>
                <div class="effect-control">
                    <label><span>Tonalidad</span><span class="effect-value" id="hueValue">0¬∞</span></label>
                    <input type="range" class="effect-slider" id="hue" min="0" max="360" value="0">
                </div>
                <div class="effect-control">
                    <label><span>Desenfoque</span><span class="effect-value" id="blurValue">0px</span></label>
                    <input type="range" class="effect-slider" id="blur" min="0" max="10" step="0.1" value="0">
                </div>
                <div class="effect-control">
                    <label><span>Sepia</span><span class="effect-value" id="sepiaValue">0%</span></label>
                    <input type="range" class="effect-slider" id="sepia" min="0" max="100" value="0">
                </div>
                <div class="effect-control">
                    <label><span>Blanco y Negro</span><span class="effect-value" id="grayscaleValue">0%</span></label>
                    <input type="range" class="effect-slider" id="grayscale" min="0" max="100" value="0">
                </div>
                <div class="effect-control">
                    <label><span>Invertir</span><span class="effect-value" id="invertValue">0%</span></label>
                    <input type="range" class="effect-slider" id="invert" min="0" max="100" value="0">
                </div>
                <div class="effect-control">
                    <label><span>Escala</span><span class="effect-value" id="scaleValue">100%</span></label>
                    <input type="range" class="effect-slider" id="scale" min="50" max="200" value="100">
                </div>
                <div class="effect-control">
                    <label><span>Rotaci√≥n</span><span class="effect-value" id="rotateValue">0¬∞</span></label>
                    <input type="range" class="effect-slider" id="rotate" min="-180" max="180" value="0">
                </div>
                <div class="effect-control">
                    <label><span>Opacidad</span><span class="effect-value" id="opacityValue">100%</span></label>
                    <input type="range" class="effect-slider" id="opacity" min="0" max="100" value="100">
                </div>
            </div>

             <div class="preset-effects">
                <h4>‚ö° Efectos R√°pidos</h4>
                <div class="preset-buttons">
                    <button class="preset-btn" id="grayscaleBtn"><span class="preset-icon">‚ö´</span><span class="preset-text">Blanco y Negro</span></button>
                    <button class="preset-btn" id="sepiaBtn"><span class="preset-icon">üü§</span><span class="preset-text">Sepia</span></button>
                    <button class="preset-btn" id="retroBtn"><span class="preset-icon">üì∫</span><span class="preset-text">Retro</span></button>
                </div>
            </div>

            <div class="senior-effects">
                <h4>üéØ SENIOR - Expert Color Grading</h4>
                <div class="effects-grid">
                    <div class="effect-control"><label><span>üìä Gamma Master</span><span class="effect-value" id="gammaMasterValue">1.00</span></label><input type="range" class="effect-slider" id="gammaMaster" min="0.1" max="3.0" step="0.01" value="1.00"></div>
                    <div class="effect-control"><label><span>üé® HSV H (Matiz)</span><span class="effect-value" id="hsvHueValue">0¬∞</span></label><input type="range" class="effect-slider" id="hsvHue" min="-180" max="180" value="0"></div>
                    <div class="effect-control"><label><span>üíé HSV S (Saturaci√≥n)</span><span class="effect-value" id="hsvSaturationValue">100%</span></label><input type="range" class="effect-slider" id="hsvSaturation" min="0" max="200" value="100"></div>
                    <div class="effect-control"><label><span>üí° HSV V (Valor)</span><span class="effect-value" id="hsvValue">100%</span></label><input type="range" class="effect-slider" id="hsvValue" min="0" max="200" value="100"></div>
                    <div class="effect-control"><label><span>‚öñÔ∏è Balance RGB - R</span><span class="effect-value" id="rgbRedValue">0%</span></label><input type="range" class="effect-slider" id="rgbRed" min="-100" max="100" value="0"></div>
                    <div class="effect-control"><label><span>‚öñÔ∏è Balance RGB - G</span><span class="effect-value" id="rgbGreenValue">0%</span></label><input type="range" class="effect-slider" id="rgbGreen" min="-100" max="100" value="0"></div>
                    <div class="effect-control"><label><span>‚öñÔ∏è Balance RGB - B</span><span class="effect-value" id="rgbBlueValue">0%</span></label><input type="range" class="effect-slider" id="rgbBlue" min="-100" max="100" value="0"></div>
                    <div class="effect-control"><label><span>üîç Exposici√≥n Selectiva</span><span class="effect-value" id="selectiveExposureValue">0%</span></label><input type="range" class="effect-slider" id="selectiveExposure" min="-100" max="100" value="0"></div>
                    <div class="effect-control"><label><span>üí® Unsharp Mask</span><span class="effect-value" id="unsharpMaskValue">0%</span></label><input type="range" class="effect-slider" id="unsharpMask" min="0" max="200" value="0"></div>
                    <div class="effect-control"><label><span>üåà Chromatic Aberration</span><span class="effect-value" id="chromaticAberrationValue">0px</span></label><input type="range" class="effect-slider" id="chromaticAberration" min="-20" max="20" step="0.1" value="0"></div>
                    <div class="effect-control"><label><span>üé≠ Tone Mapping</span><span class="effect-value" id="toneMappingValue">0%</span></label><input type="range" class="effect-slider" id="toneMapping" min="-100" max="100" value="0"></div>
                    <div class="effect-control"><label><span>‚ö° Dodge & Burn</span><span class="effect-value" id="dodgeBurnValue">0%</span></label><input type="range" class="effect-slider" id="dodgeBurn" min="-100" max="100" value="0"></div>
                </div>
            </div>

            <div class="advanced-effects">
                <h4>üñ•Ô∏è Ultra HD Profesional</h4>
                <div class="effects-grid">
                    <div class="effect-control"><label><span>üóª Nitidez HD</span><span class="effect-value" id="sharpnessValue">0%</span></label><input type="range" class="effect-slider" id="sharpness" min="0" max="100" value="0"></div>
                    <div class="effect-control"><label><span>üîç Claridad</span><span class="effect-value" id="clarityValue">0%</span></label><input type="range" class="effect-slider" id="clarity" min="0" max="100" value="0"></div>
                    <div class="effect-control"><label><span>‚ú® Mejora Detalles</span><span class="effect-value" id="detailEnhanceValue">0%</span></label><input type="range" class="effect-slider" id="detailEnhance" min="0" max="100" value="0"></div>
                    <div class="effect-control"><label><span>üìê Contraste Local</span><span class="effect-value" id="localContrastValue">0%</span></label><input type="range" class="effect-slider" id="localContrast" min="0" max="100" value="0"></div>
                    <div class="effect-control"><label><span>üîß Reducci√≥n Ruido</span><span class="effect-value" id="noiseReductionValue">0%</span></label><input type="range" class="effect-slider" id="noiseReduction" min="0" max="100" value="0"></div>
                    <div class="effect-control"><label><span>‚ö° Realce Bordes</span><span class="effect-value" id="edgeEnhanceValue">0%</span></label><input type="range" class="effect-slider" id="edgeEnhance" min="0" max="100" value="0"></div>
                </div>
            </div>

            <div class="advanced-effects">
                <h4>üé¨ Color Avanzado Netflix</h4>
                <div class="effects-grid">
                    <div class="effect-control"><label><span>Sombras Fr√≠as</span><span class="effect-value" id="shadowsColdValue">0%</span></label><input type="range" class="effect-slider" id="shadowsCold" min="-100" max="100" value="0"></div>
                    <div class="effect-control"><label><span>Highlights C√°lidos</span><span class="effect-value" id="highlightsWarmValue">0%</span></label><input type="range" class="effect-slider" id="highlightsWarm" min="-100" max="100" value="0"></div>
                    <div class="effect-control"><label><span>Vignetting</span><span class="effect-value" id="vignettingValue">0%</span></label><input type="range" class="effect-slider" id="vignetting" min="0" max="50" value="0"></div>
                    <div class="effect-control"><label><span>Background</span><span class="effect-value" id="backgroundValue">50%</span></label><input type="range" class="effect-slider" id="background" min="0" max="100" value="50"></div>
                    <div class="effect-control"><label><span>Intensidad</span><span class="effect-value" id="intensityValue">100%</span></label><input type="range" class="effect-slider" id="intensity" min="0" max="200" value="100"></div>
                    <div class="effect-control"><label><span>Ratio</span><span class="effect-value" id="ratioValue">50%</span></label><input type="range" class="effect-slider" id="ratio" min="0" max="100" value="50"></div>
                    <div class="effect-control"><label><span>Tono de Piel</span><span class="effect-value" id="skinToneValue">0%</span></label><input type="range" class="effect-slider" id="skinTone" min="-50" max="50" value="0"></div>
                    <div class="effect-control"><label><span>Temperatura</span><span class="effect-value" id="temperatureValue">0K</span></label><input type="range" class="effect-slider" id="temperature" min="-1000" max="1000" value="0"></div>
                </div>
            </div>

            <div class="genre-presets">
                <h4>üé≠ Configuraciones por G√©nero</h4>
                <div class="preset-buttons">
                    <button class="genre-btn" data-genre="cinematic"><span class="genre-icon">üé¨</span><span class="genre-text">Cinematogr√°fico</span></button>
                    <button class="genre-btn" data-genre="interview"><span class="genre-icon">üéôÔ∏è</span><span class="genre-text">Entrevistas</span></button>
                    <button class="genre-btn" data-genre="thriller"><span class="genre-icon">üïµÔ∏è</span><span class="genre-text">Thriller</span></button>
                    <button class="genre-btn" data-genre="drama"><span class="genre-icon">üíî</span><span class="genre-text">Drama</span></button>
                    <button class="genre-btn" data-genre="scifi"><span class="genre-icon">üöÄ</span><span class="genre-text">Sci-Fi</span></button>
                    <button class="genre-btn" data-genre="comedy"><span class="genre-icon">üòÇ</span><span class="genre-text">Comedia</span></button>
                    <button class="genre-btn" data-genre="vivido"><span class="genre-icon">üåü</span><span class="genre-text">Vivido</span></button>
                    <button class="genre-btn" data-genre="pixelHDR"><span class="genre-icon">üöÄ</span><span class="genre-text">Pixel HDR</span></button>
                    <button class="genre-btn" data-genre="terror"><span class="genre-icon">üåô</span><span class="genre-text">Terror</span></button>
                </div>
            </div>

            <div class="effects-actions">
                <button class="control-btn" id="resetEffects">Restablecer</button>
                <button class="control-btn" id="saveEffects">Aplicar</button>
                <button class="control-btn" id="closeEffects">Cerrar</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        class YouTubeOverlayPlayer {
            constructor() {
                this.currentVideoId = '';
                this.startTime = 0;
                this.endTime = 0;
                this.duration = 0;
                this.isPlaying = false;
                this.isRangeMode = false;
                this.zoomLevel = 100;
                this.updateInterval = null;
                this.videoStartTime = 0; // Para c√°lculo de tiempo restante
                
                this.initializeElements();
                this.bindEvents();
                this.showNotification('Configura un video para comenzar', 'info');
            }

            initializeElements() {
                this.elements = {
                    youtubeBackground: document.getElementById('youtubeBackground'),
                    videoTitle: document.getElementById('videoTitle'),
                    videoRange: document.getElementById('videoRange'),
                    
                    // Timeline elementos
                    timelineWrapper: document.getElementById('timelineWrapper'),
                    timelineScrollArea: document.getElementById('timelineScrollArea'),
                    progressContainer: document.getElementById('progressContainer'),
                    progressBarFill: document.getElementById('progressBarFill'),
                    playhead: document.getElementById('playhead'),
                    zoomInBtn: document.getElementById('zoomInBtn'),
                    zoomOutBtn: document.getElementById('zoomOutBtn'),
                    
                    // Inputs de tiempo
                    startTime: document.getElementById('startTime'),
                    endTime: document.getElementById('endTime'),
                    playRangeBtn: document.getElementById('playRangeBtn'),
                    
                    // Configuraci√≥n
                    configBtn: document.getElementById('configBtn'),
                    effectsBtn: document.getElementById('effectsBtn'),
                    fullscreenBtn: document.getElementById('fullscreenBtn'),
                    configPanel: document.getElementById('configPanel'),
                    effectsPanel: document.getElementById('effectsPanel'),
                    videoUrl: document.getElementById('videoUrl'),
                    cancelConfig: document.getElementById('cancelConfig'),
                    loadVideo: document.getElementById('loadVideo'),
                    videoQuality: document.getElementById('videoQuality'),
                    
                    // Efectos
                    brightness: document.getElementById('brightness'),
                    contrast: document.getElementById('contrast'),
                    saturate: document.getElementById('saturate'),
                    hue: document.getElementById('hue'),
                    blur: document.getElementById('blur'),
                    sepia: document.getElementById('sepia'),
                    grayscale: document.getElementById('grayscale'),
                    invert: document.getElementById('invert'),
                    scale: document.getElementById('scale'),
                    rotate: document.getElementById('rotate'),
                    opacity: document.getElementById('opacity'),
                    sharpness: document.getElementById('sharpness'),
                    clarity: document.getElementById('clarity'),
                    detailEnhance: document.getElementById('detailEnhance'),
                    localContrast: document.getElementById('localContrast'),
                    noiseReduction: document.getElementById('noiseReduction'),
                    edgeEnhance: document.getElementById('edgeEnhance'),
                    gammaMaster: document.getElementById('gammaMaster'),
                    hsvHue: document.getElementById('hsvHue'),
                    hsvSaturation: document.getElementById('hsvSaturation'),
                    hsvValue: document.getElementById('hsvValue'),
                    rgbRed: document.getElementById('rgbRed'),
                    rgbGreen: document.getElementById('rgbGreen'),
                    rgbBlue: document.getElementById('rgbBlue'),
                    selectiveExposure: document.getElementById('selectiveExposure'),
                    unsharpMask: document.getElementById('unsharpMask'),
                    chromaticAberration: document.getElementById('chromaticAberration'),
                    toneMapping: document.getElementById('toneMapping'),
                    dodgeBurn: document.getElementById('dodgeBurn'),
                    shadowsCold: document.getElementById('shadowsCold'),
                    highlightsWarm: document.getElementById('highlightsWarm'),
                    vignetting: document.getElementById('vignetting'),
                    background: document.getElementById('background'),
                    intensity: document.getElementById('intensity'),
                    ratio: document.getElementById('ratio'),
                    skinTone: document.getElementById('skinTone'),
                    temperature: document.getElementById('temperature'),
                    brightnessValue: document.getElementById('brightnessValue'),
                    contrastValue: document.getElementById('contrastValue'),
                    saturateValue: document.getElementById('saturateValue'),
                    hueValue: document.getElementById('hueValue'),
                    blurValue: document.getElementById('blurValue'),
                    sepiaValue: document.getElementById('sepiaValue'),
                    grayscaleValue: document.getElementById('grayscaleValue'),
                    invertValue: document.getElementById('invertValue'),
                    scaleValue: document.getElementById('scaleValue'),
                    rotateValue: document.getElementById('rotateValue'),
                    opacityValue: document.getElementById('opacityValue'),
                    sharpnessValue: document.getElementById('sharpnessValue'),
                    clarityValue: document.getElementById('clarityValue'),
                    detailEnhanceValue: document.getElementById('detailEnhanceValue'),
                    localContrastValue: document.getElementById('localContrastValue'),
                    noiseReductionValue: document.getElementById('noiseReductionValue'),
                    edgeEnhanceValue: document.getElementById('edgeEnhanceValue'),
                    gammaMasterValue: document.getElementById('gammaMasterValue'),
                    hsvHueValue: document.getElementById('hsvHueValue'),
                    hsvSaturationValue: document.getElementById('hsvSaturationValue'),
                    rgbRedValue: document.getElementById('rgbRedValue'),
                    rgbGreenValue: document.getElementById('rgbGreenValue'),
                    rgbBlueValue: document.getElementById('rgbBlueValue'),
                    selectiveExposureValue: document.getElementById('selectiveExposureValue'),
                    unsharpMaskValue: document.getElementById('unsharpMaskValue'),
                    chromaticAberrationValue: document.getElementById('chromaticAberrationValue'),
                    toneMappingValue: document.getElementById('toneMappingValue'),
                    dodgeBurnValue: document.getElementById('dodgeBurnValue'),
                    shadowsColdValue: document.getElementById('shadowsColdValue'),
                    highlightsWarmValue: document.getElementById('highlightsWarmValue'),
                    vignettingValue: document.getElementById('vignettingValue'),
                    backgroundValue: document.getElementById('backgroundValue'),
                    intensityValue: document.getElementById('intensityValue'),
                    ratioValue: document.getElementById('ratioValue'),
                    skinToneValue: document.getElementById('skinToneValue'),
                    temperatureValue: document.getElementById('temperatureValue'),
                    resetEffects: document.getElementById('resetEffects'),
                    saveEffects: document.getElementById('saveEffects'),
                    closeEffects: document.getElementById('closeEffects'),
                    grayscaleBtn: document.getElementById('grayscaleBtn'),
                    sepiaBtn: document.getElementById('sepiaBtn'),
                    retroBtn: document.getElementById('retroBtn'),
                    genreButtons: document.querySelectorAll('.genre-btn'),
                    notification: document.getElementById('notification')
                };
                
                this.effects = {
                    brightness: 100, contrast: 100, saturate: 100, hue: 0, blur: 0, sepia: 0, grayscale: 0, invert: 0, scale: 100, rotate: 0, opacity: 100,
                    sharpness: 0, clarity: 0, detailEnhance: 0, localContrast: 0, noiseReduction: 0, edgeEnhance: 0,
                    shadowsCold: 0, highlightsWarm: 0, vignetting: 0, background: 50, intensity: 100, ratio: 50, skinTone: 0, temperature: 0,
                    gammaMaster: 1.00, hsvHue: 0, hsvSaturation: 100, hsvValue: 100, rgbRed: 0, rgbGreen: 0, rgbBlue: 0, selectiveExposure: 0, unsharpMask: 0, chromaticAberration: 0, toneMapping: 0, dodgeBurn: 0
                };

                this.presetEffects = { grayscale: false, sepia: false, retro: false };
            }

            bindEvents() {
                // Configuraci√≥n
                this.elements.configBtn.addEventListener('click', () => this.showConfig());
                this.elements.cancelConfig.addEventListener('click', () => this.hideConfig());
                this.elements.loadVideo.addEventListener('click', () => this.loadVideo());
                this.elements.videoUrl.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.loadVideo();
                });

                // Efectos
                this.elements.effectsBtn.addEventListener('click', () => this.showEffects());
                this.elements.closeEffects.addEventListener('click', () => this.hideEffects());
                this.elements.resetEffects.addEventListener('click', () => this.resetEffects());
                this.elements.saveEffects.addEventListener('click', () => this.saveEffects());
                
                this.elements.grayscaleBtn.addEventListener('click', () => this.toggleGrayscale());
                this.elements.sepiaBtn.addEventListener('click', () => this.toggleSepia());
                this.elements.retroBtn.addEventListener('click', () => this.toggleRetro());

                // Listeners para todos los sliders
                const effectSliders = ['brightness', 'contrast', 'saturate', 'hue', 'blur', 'sepia', 'grayscale', 'invert', 'scale', 'rotate', 'opacity', 'sharpness', 'clarity', 'detailEnhance', 'localContrast', 'noiseReduction', 'edgeEnhance', 'gammaMaster', 'hsvHue', 'hsvSaturation', 'hsvValue', 'rgbRed', 'rgbGreen', 'rgbBlue', 'selectiveExposure', 'unsharpMask', 'chromaticAberration', 'toneMapping', 'dodgeBurn', 'shadowsCold', 'highlightsWarm', 'vignetting', 'background', 'intensity', 'ratio', 'skinTone', 'temperature'];
                
                effectSliders.forEach(effect => {
                    if (this.elements[effect]) {
                        this.elements[effect].addEventListener('input', (e) => this.updateEffect(effect, parseFloat(e.target.value)));
                    }
                });

                this.elements.genreButtons.forEach(button => {
                    button.addEventListener('click', () => this.applyGenrePreset(button.dataset.genre));
                });

                this.elements.fullscreenBtn.addEventListener('click', () => this.toggleFullscreen());
                this.elements.videoQuality.addEventListener('change', () => this.changeVideoQuality());
                
                // Nuevos eventos para timeline
                this.elements.playRangeBtn.addEventListener('click', () => this.playRange());
                this.elements.zoomInBtn.addEventListener('click', () => this.handleZoom(1));
                this.elements.zoomOutBtn.addEventListener('click', () => this.handleZoom(-1));
                this.elements.progressContainer.addEventListener('mousedown', (e) => this.scrubTimeline(e));
                
                document.addEventListener('keydown', (e) => this.handleKeyboard(e));
            }

            extractVideoId(url) {
                const patterns = [
                    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
                    /youtube\.com\/v\/([^&\n?#]+)/
                ];
                for (const pattern of patterns) {
                    const match = url.match(pattern);
                    if (match) return match[1];
                }
                return null;
            }

            loadVideo() {
                const url = this.elements.videoUrl.value.trim();
                if (!url) { this.showNotification('Por favor, ingresa una URL de YouTube', 'error'); return; }
                const videoId = this.extractVideoId(url);
                if (!videoId) { this.showNotification('URL de YouTube no v√°lida', 'error'); return; }
                this.currentVideoId = videoId;
                
                // Inicializar duraci√≥n como indefinida
                this.duration = null;
                this.elements.endTime.value = '--:--';
                this.elements.videoRange.textContent = 'Duraci√≥n: cargando...';
                
                // Cargar video en el iframe de YouTube (m√©todo actual)
                const currentQuality = this.elements.videoQuality.value;
                const qualityParam = currentQuality !== 'auto' ? `&vq=${currentQuality}` : '';
                const embedUrl = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&controls=0&showinfo=0&modestbranding=1&rel=0&fs=1&autoplay=1${qualityParam}`;
                this.elements.youtubeBackground.src = embedUrl;
                
                this.elements.videoTitle.textContent = `Video: ${videoId.substring(0, 8)}...`;
                this.hideConfig();
                this.showNotification('Video cargado correctamente', 'success');
                
                // Resetear estado de timeline
                this.isRangeMode = false;
                this.elements.timelineWrapper.classList.remove('active');
                this.elements.playRangeBtn.textContent = '‚ñ∂Ô∏è CARGAR RANGO';
                this.elements.endTime.value = '--:--';
                this.resetProgressBar();
                
                // Configurar listener para obtener duraci√≥n del iframe de YouTube
                this.setupYouTubeMessageListener();
                
                // Intentar obtener duraci√≥n mediante m√©todos alternativos
                this.estimateDurationImproved(videoId);
            }

            async getVideoDurationFromApi(videoId) {
                // Usar noembed.com para verificar que el video existe
                try {
                    const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.provider_name === 'YouTube') {
                            // El video existe, podemos usar duraci√≥n estimada mejorada
                            this.generateIntelligentEstimate(videoId);
                            return;
                        } else {
                            throw new Error('Video no v√°lido');
                        }
                    }
                } catch (error) {
                    console.log('Error verificando video:', error);
                    // Usar duraci√≥n por defecto
                    setTimeout(() => {
                        this.updateVideoDuration(300);
                        this.showNotification('Video no encontrado. Usando duraci√≥n por defecto de 5 minutos', 'error');
                    }, 1000);
                }
            }

            async getDurationFromAlternativeSources(videoId) {
                // Intentar m√∫ltiples fuentes para obtener duraci√≥n
                const sources = [
                    // M√©todo con informaci√≥n de video p√∫blico
                    () => this.getDurationFromVideoPage(videoId),
                    // M√©todo con estimaci√≥n inteligente
                    () => this.getDurationFromVideoInfo(videoId)
                ];

                for (let i = 0; i < sources.length; i++) {
                    try {
                        await sources[i]();
                        if (this.duration && this.duration !== 300) {
                            return; // √âxito, salir del loop
                        }
                    } catch (error) {
                        console.log(`M√©todo ${i + 1} fall√≥:`, error);
                    }
                }

                // Si todos los m√©todos fallaron, usar estimaci√≥n
                this.fallbackDuration(videoId);
            }

            async getDurationFromVideoPage(videoId) {
                // Este m√©todo intentar√≠a obtener duraci√≥n de la p√°gina del video
                // Pero debido a CORS, usaremos un enfoque alternativo
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve();
                    }, 1000);
                });
            }

            async getDurationFromWebPage(videoId) {
                try {
                    // Usar servicio alternativo para obtener duraci√≥n
                    const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.title) {
                            // Si el video existe pero no tenemos duraci√≥n, intentamos otras aproximaciones
                            await this.tryAlternativeDurationMethods(videoId);
                        }
                    }
                } catch (error) {
                    console.log('Error obteniendo duraci√≥n:', error);
                }

                // Fallback: usar m√©todo de estimaci√≥n basado en la URL del video
                this.estimateDurationFromVideoId(videoId);
            }

            async tryAlternativeDurationMethods(videoId) {
                // M√©todo 1: Intentar obtener de la p√°gina HTML (m√©todo CORS)
                try {
                    const proxyUrl = `https://cors-anywhere.herokuapp.com/https://www.youtube.com/watch?v=${videoId}`;
                    const response = await fetch(proxyUrl);
                    if (response.ok) {
                        const html = await response.text();
                        const durationMatch = html.match(/"lengthSeconds":"(\d+)"/);
                        if (durationMatch && durationMatch[1]) {
                            const duration = parseInt(durationMatch[1]);
                            this.updateVideoDuration(duration);
                            return;
                        }
                    }
                } catch (error) {
                    console.log('M√©todo proxy fall√≥:', error);
                }

                // M√©todo 2: Esperar a que el usuario reproduzca el video para obtener duraci√≥n real
                setTimeout(() => {
                    this.showNotification('Para duraci√≥n exacta, reproduce el video completamente', 'info');
                    this.listenForRealDuration();
                }, 2000);
            }

            listenForRealDuration() {
                // Esta funci√≥n escuchar√° cuando el video empiece a reproducirse
                // para obtener la duraci√≥n real de YouTube
                if (this.durationListener) {
                    clearTimeout(this.durationListener);
                }

                // Esperar hasta 30 segundos para que el usuario reproduzca el video
                this.durationListener = setTimeout(() => {
                    if (!this.duration || this.duration === 300) {
                        // Si no se pudo obtener duraci√≥n, mantener estimado
                        this.updateVideoDuration(300);
                        this.showNotification('Usando duraci√≥n estimada de 5 minutos', 'info');
                    }
                }, 30000);
            }

            estimateDurationImproved(videoId) {
                // Usar m√©todos mejorados para estimar duraci√≥n
                this.getVideoDurationFromApi(videoId).catch(() => {
                    // Si falla, usar duraci√≥n inteligente basada en caracter√≠sticas del video
                    this.generateIntelligentEstimate(videoId);
                });
            }

            generateIntelligentEstimate(videoId) {
                // Mejorar la estimaci√≥n usando patrones comunes
                let estimatedDuration = 300; // 5 minutos por defecto

                // M√©todo 1: Basado en hash pero mejorado
                let hash = 0;
                for (let i = 0; i < videoId.length; i++) {
                    const char = videoId.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                
                // Generar duraci√≥n m√°s realista entre 1 y 30 minutos
                const estimatedMinutes = Math.abs(hash % 29) + 1; // 1-30 minutos
                estimatedDuration = estimatedMinutes * 60;
                
                // M√©todo 2: Usar patrones espec√≠ficos de video ID
                const videoIdChars = videoId.toLowerCase();
                let bonusTime = 0;
                
                // Algunos patrones sugieren videos m√°s largos
                if (videoIdChars.includes('tutorial') || videoIdChars.includes('tutorial') || 
                    videoIdChars.includes('complete') || videoIdChars.includes('full')) {
                    bonusTime += 300; // +5 minutos para tutoriales/completos
                }
                
                estimatedDuration += bonusTime;
                estimatedDuration = Math.min(estimatedDuration, 3600); // M√°ximo 60 minutos

                setTimeout(() => {
                    this.updateVideoDuration(estimatedDuration);
                    this.showNotification(`Duraci√≥n estimada: ${this.formatTime(estimatedDuration)} (mejorada)`, 'info');
                }, 2000);
            }

            updateVideoDuration(duration) {
                this.duration = duration;
                // Actualizar campo "Hasta" con duraci√≥n real del video
                this.elements.endTime.value = this.formatTime(duration);
                this.elements.videoRange.textContent = `Duraci√≥n: ${this.formatTime(duration)}`;
                this.showNotification(`Video cargado. Duraci√≥n: ${this.formatTime(duration)}`, 'success');
            }

            setupYouTubeMessageListener() {
                // Limpiar listener anterior y timeouts
                if (this.youtubeMessageListener) {
                    window.removeEventListener('message', this.youtubeMessageListener);
                    this.youtubeMessageListener = null;
                }
                
                if (this.durationListener) {
                    clearTimeout(this.durationListener);
                    this.durationListener = null;
                }

                this.youtubeMessageListener = (event) => {
                    // Verificar origen del mensaje (important for security)
                    if (event.origin !== 'https://www.youtube.com' && event.origin !== 'https://youtube.com' && event.origin !== 'https://www.youtube-nocookie.com') {
                        return;
                    }

                    try {
                        const data = event.data;
                        
                        // YouTube messages often come as strings, try to parse
                        let parsedData = data;
                        if (typeof data === 'string') {
                            try {
                                parsedData = JSON.parse(data);
                            } catch (e) {
                                // Not a JSON message
                                return;
                            }
                        }

                        // Check for duration information
                        if (parsedData && parsedData.info) {
                            const duration = parsedData.info.duration || parsedData.info.length || parsedData.info.videoData?.length;
                            if (duration && this.duration !== duration) {
                                this.duration = duration;
                                this.elements.endTime.value = this.formatTime(duration);
                                this.elements.videoRange.textContent = `Duraci√≥n: ${this.formatTime(duration)}`;
                                console.log('Duraci√≥n obtenida del iframe de YouTube:', this.formatTime(duration));
                                this.showNotification(`Duraci√≥n actualizada: ${this.formatTime(duration)}`, 'success');
                            }
                        }

                        // Check for other duration-related events
                        if (parsedData && (parsedData.event === 'video-progress' || parsedData.event === 'state-change') && parsedData.currentTime) {
                            // Video is playing, we might get duration info soon
                            this.setupDurationListener();
                        }
                    } catch (error) {
                        // Ignore parsing errors
                    }
                };

                window.addEventListener('message', this.youtubeMessageListener);
                
                // Also try to listen for iframe load events
                this.elements.youtubeBackground.addEventListener('load', () => {
                    setTimeout(() => this.requestDurationFromIframe(), 2000);
                });
            }

            requestDurationFromIframe() {
                // Send a message to the iframe to request video duration
                if (this.elements.youtubeBackground && this.elements.youtubeBackground.contentWindow) {
                    try {
                        this.elements.youtubeBackground.contentWindow.postMessage(JSON.stringify({
                            event: 'command',
                            func: 'getCurrentTime',
                            args: []
                        }), '*');
                    } catch (error) {
                        console.log('No se pudo solicitar duraci√≥n al iframe:', error);
                    }
                }
            }

            setupDurationListener() {
                // Set up a listener that waits for the user to play the video
                // and then captures the real duration
                const checkDuration = () => {
                    if (this.player) {
                        try {
                            const duration = this.player.getDuration();
                            if (duration && duration > 0 && duration !== this.duration) {
                                this.duration = duration;
                                this.elements.endTime.value = this.formatTime(duration);
                                this.elements.videoRange.textContent = `Duraci√≥n: ${this.formatTime(duration)}`;
                                this.showNotification(`Duraci√≥n real del video: ${this.formatTime(duration)}`, 'success');
                                return;
                            }
                        } catch (error) {
                            // Player not ready yet
                        }
                    }
                    
                    // Try again in 1 second if we don't have duration yet
                    if (!this.duration || this.duration === 300) {
                        setTimeout(checkDuration, 1000);
                    }
                };

                setTimeout(checkDuration, 2000); // Start checking after 2 seconds
            }

            changeVideoQuality() {
                if (!this.currentVideoId) { this.showNotification('Primero carga un video', 'info'); return; }
                const currentQuality = this.elements.videoQuality.value;
                const qualityParam = currentQuality !== 'auto' ? `&vq=${currentQuality}` : '';
                const embedUrl = `https://www.youtube.com/embed/${this.currentVideoId}?enablejsapi=1&controls=0&showinfo=0&modestbranding=1&rel=0&fs=1&autoplay=1${qualityParam}`;
                this.elements.youtubeBackground.src = embedUrl;
                const qualityNames = { 'auto': 'Autom√°tica', 'hd1080': '1080p HD', 'hd720': '720p HD', 'medium': '480p', 'small': '360p', 'tiny': '240p' };
                this.showNotification(`Calidad cambiada a: ${qualityNames[currentQuality] || currentQuality}`, 'info');
            }

            playRange() {
                if (!this.currentVideoId) { 
                    this.showNotification('Primero configura un video', 'error'); 
                    return; 
                }
                
                // Usar duraci√≥n estimada si no se ha establecido
                if (!this.duration || this.duration === 0) {
                    this.duration = 300; // 5 minutos por defecto
                }
                
                const startTime = this.parseTime(this.elements.startTime.value);
                let endTime = this.parseTime(this.elements.endTime.value);
                
                // Si el campo "Hasta" tiene --:-- o est√° vac√≠o, usar la duraci√≥n del video
                if (this.elements.endTime.value === '--:--' || !this.elements.endTime.value || endTime <= 0) {
                    endTime = this.duration;
                    this.elements.endTime.value = this.formatTime(endTime);
                }
                
                if (startTime >= endTime) { 
                    this.showNotification('El tiempo de inicio debe ser menor que el final', 'error'); 
                    return; 
                }
                
                this.startTime = startTime;
                this.endTime = endTime;
                this.isRangeMode = true;
                this.videoStartTime = Date.now();
                
                const seekUrl = `https://www.youtube.com/embed/${this.currentVideoId}?start=${startTime}&end=${endTime}&enablejsapi=1&controls=0&showinfo=0&modestbranding=1&rel=0&fs=1&autoplay=1`;
                this.elements.youtubeBackground.src = seekUrl;
                
                this.elements.videoRange.textContent = `0:00 / ${this.formatTime(endTime - startTime)}`;
                this.showNotification(`Reproduciendo rango: ${this.formatTime(startTime)} ‚Üí ${this.formatTime(endTime)}`, 'success');
                
                // Activar timeline y ajustar zoom
                this.elements.timelineWrapper.classList.add('active');
                this.resetProgressBar();
                this.startProgressSimulation();
                
                // Cambiar texto del bot√≥n
                this.elements.playRangeBtn.textContent = '‚ùö‚ùö PAUSA';
            }

            resetProgressBar() {
                this.elements.progressBarFill.style.width = '0%';
                this.elements.playhead.style.left = '0%';
            }

            startProgressSimulation() {
                this.stopProgressSimulation();
                this.isPlaying = true;
                this.updateProgress();
            }

            stopProgressSimulation() {
                this.isPlaying = false;
            }

            updateProgress() {
                if (!this.isPlaying || !this.isRangeMode) return;
                
                const elapsed = (Date.now() - this.videoStartTime) / 1000;
                const rangeDuration = this.endTime - this.startTime;
                
                // Calcular progreso basado en tiempo transcurrido
                const progress = Math.min((elapsed / rangeDuration) * 100, 100);
                this.elements.progressBarFill.style.width = `${progress}%`;
                this.elements.playhead.style.left = `${progress}%`;
                
                // Actualizar contador de tiempo
                const elapsedInRange = Math.min(elapsed, rangeDuration);
                const remainingTime = Math.max(0, rangeDuration - elapsedInRange);
                
                this.elements.videoRange.textContent = `${this.formatTime(elapsedInRange)} / ${this.formatTime(rangeDuration)} (Restante: ${this.formatTime(remainingTime)})`;
                
                if (progress >= 100) {
                    this.stopProgressSimulation();
                    this.elements.playRangeBtn.textContent = 'üîÑ REPETIR RANGO';
                    this.showNotification('Rango de reproducci√≥n completado', 'success');
                    return;
                }
                
                setTimeout(() => this.updateProgress(), 100);
            }

            handleZoom(direction) {
                if (!this.isRangeMode) return;

                if (direction === 1) {
                    this.zoomLevel = Math.min(1000, this.zoomLevel + 50);
                } else {
                    this.zoomLevel = Math.max(100, this.zoomLevel - 50);
                }
                
                this.applyZoom();
            }

            applyZoom() {
                this.elements.progressContainer.style.width = `${this.zoomLevel}%`;
                this.showNotification(`Zoom: ${this.zoomLevel}%`, 'info');
            }

            scrubTimeline(e) {
                if (!this.isRangeMode) {
                    // NUEVA FUNCIONALIDAD: Scrubbing para video normal de YouTube
                    this.scrubVideoNormal(e);
                    return;
                }

                const rect = this.elements.timelineScrollArea.getBoundingClientRect();
                const containerWidth = this.elements.progressContainer.offsetWidth;
                
                const clickXRelativeToScroll = e.clientX - rect.left + this.elements.timelineScrollArea.scrollLeft;
                const percent = clickXRelativeToScroll / containerWidth;
                
                const rangeDuration = this.endTime - this.startTime;
                const newTime = this.startTime + (percent * rangeDuration);
                
                // Actualizar barra de progreso inmediatamente
                this.elements.playhead.style.left = `${percent * 100}%`;
                this.elements.progressBarFill.style.width = `${percent * 100}%`;
                
                // Actualizar contador de tiempo
                const elapsedInRange = newTime - this.startTime;
                const remainingTime = rangeDuration - elapsedInRange;
                this.elements.videoRange.textContent = `${this.formatTime(Math.max(0, elapsedInRange))} / ${this.formatTime(rangeDuration)} (Restante: ${this.formatTime(Math.max(0, remainingTime))})`;
                
                // Actualizar tiempo de video con nueva URL
                const newUrl = `https://www.youtube.com/embed/${this.currentVideoId}?start=${Math.max(this.startTime, newTime)}&end=${this.endTime}&enablejsapi=1&controls=0&showinfo=0&modestbranding=1&rel=0&fs=1&autoplay=1`;
                this.elements.youtubeBackground.src = newUrl;
                
                // Reiniciar tiempo de inicio para simulaci√≥n
                this.videoStartTime = Date.now() - (elapsedInRange * 1000);
            }

            playPause() {
                if (!this.currentVideoId) { this.showNotification('Primero configura un video', 'error'); return; }
                
                if (this.isRangeMode) {
                    // Modo rango existente - NO TOCAR
                    if (this.isPlaying) {
                        this.stopProgressSimulation();
                        this.elements.playRangeBtn.textContent = '‚ñ∂Ô∏è REPRODUCIR';
                    } else {
                        this.startProgressSimulation();
                        this.elements.playRangeBtn.textContent = '‚ùö‚ùö PAUSA';
                    }
                } else {
                    // NUEVA FUNCIONALIDAD: Video normal de YouTube
                    this.controlVideoPlayback();
                }
            }

            controlVideoPlayback() {
                // Enviar comando al iframe de YouTube usando el mismo patr√≥n existente
                if (this.elements.youtubeBackground && this.elements.youtubeBackground.contentWindow) {
                    try {
                        // Determinar comando basado en estado actual
                        const isPlaying = this.isPlaying;
                        const command = isPlaying ? 'pauseVideo' : 'playVideo';
                        
                        this.elements.youtubeBackground.contentWindow.postMessage(JSON.stringify({
                            event: 'command',
                            func: command,
                            args: []
                        }), '*');
                        
                        // Actualizar estado local
                        this.isPlaying = !isPlaying;
                        this.elements.playRangeBtn.textContent = isPlaying ? '‚ñ∂Ô∏è REPRODUCIR' : '‚ùö‚ùö PAUSA';
                        
                        console.log(`Comando enviado al video: ${command}`);
                    } catch (error) {
                        console.log('Error enviando comando al video:', error);
                        this.showNotification('No se pudo controlar la reproducci√≥n', 'error');
                    }
                } else {
                    this.showNotification('Video no disponible', 'error');
                }
            }

            scrubVideoNormal(e) {
                // Solo funciona si hay un video cargado
                if (!this.currentVideoId || !this.duration) {
                    this.showNotification('Primero carga un video', 'info');
                    return;
                }

                const rect = this.elements.timelineScrollArea.getBoundingClientRect();
                const containerWidth = this.elements.progressContainer.offsetWidth;
                
                // Calcular porcentaje donde el usuario hizo click
                const clickXRelativeToScroll = e.clientX - rect.left + this.elements.timelineScrollArea.scrollLeft;
                const percent = Math.max(0, Math.min(1, clickXRelativeToScroll / containerWidth));
                
                // Calcular tiempo objetivo basado en la duraci√≥n del video
                const targetTime = percent * this.duration;
                
                // Enviar comando al iframe para saltar al tiempo deseado
                if (this.elements.youtubeBackground && this.elements.youtubeBackground.contentWindow) {
                    try {
                        this.elements.youtubeBackground.contentWindow.postMessage(JSON.stringify({
                            event: 'command',
                            func: 'seekTo',
                            args: [targetTime]
                        }), '*');
                        
                        // Actualizar barra de progreso visual
                        this.elements.playhead.style.left = `${percent * 100}%`;
                        this.elements.progressBarFill.style.width = `${percent * 100}%`;
                        
                        console.log(`Video saltado a: ${this.formatTime(targetTime)} (${Math.round(percent * 100)}%)`);
                    } catch (error) {
                        console.log('Error saltando el video:', error);
                        this.showNotification('No se pudo saltar a esa posici√≥n', 'error');
                    }
                } else {
                    this.showNotification('Video no disponible para saltar', 'error');
                }
            }

            seekTo(event) {
                // Mantener compatibilidad con c√≥digo original
                this.scrubTimeline(event);
            }

            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().then(() => {
                        this.hideAllControls();
                        this.showNotification('Modo pantalla completa activado', 'info');
                    });
                } else {
                    document.exitFullscreen().then(() => {
                        this.showAllControls();
                        this.showNotification('Modo pantalla completa desactivado', 'info');
                    });
                }
            }
            
            hideAllControls() {
                const overlayLayer = document.getElementById('overlayLayer');
                overlayLayer.style.opacity = '0';
                overlayLayer.style.pointerEvents = 'none';
                this.hideConfig();
                this.hideEffects();
            }
            
            showAllControls() {
                const overlayLayer = document.getElementById('overlayLayer');
                overlayLayer.style.opacity = '1';
                overlayLayer.style.pointerEvents = 'auto';
            }

            showConfig() {
                const panel = this.elements.configPanel;
                if (panel) {
                    panel.classList.add('show');
                    this.hideEffects();
                }
            }

            hideConfig() {
                const panel = this.elements.configPanel;
                if (panel) panel.classList.remove('show');
            }

            showEffects() {
                const panel = this.elements.effectsPanel;
                if (panel) {
                    panel.classList.add('show');
                    this.hideConfig();
                }
            }

            hideEffects() {
                const panel = this.elements.effectsPanel;
                if (panel) panel.classList.remove('show');
            }

            updateEffect(effectName, value) {
                this.effects[effectName] = value;
                const valueElement = this.elements[effectName + 'Value'];
                if (valueElement) {
                    let displayValue = '';
                    switch(effectName) {
                        case 'hue': case 'rotate': case 'hsvHue': case 'temperature': displayValue = value + '¬∞'; break;
                        case 'blur': case 'chromaticAberration': displayValue = value + 'px'; break;
                        case 'gammaMaster': displayValue = parseFloat(value).toFixed(2); break;
                        default: displayValue = value + '%';
                    }
                    valueElement.textContent = displayValue;
                }
                this.applyEffects();
            }

            applyEffects() {
                const { youtubeBackground } = this.elements;
                if (!youtubeBackground) return;
                
                let filters = [
                    `brightness(${this.effects.brightness}%)`,
                    `contrast(${this.effects.contrast}%)`,
                    `saturate(${this.effects.saturate}%)`,
                    `blur(${this.effects.blur}px)`,
                    `sepia(${this.effects.sepia}%)`,
                    `grayscale(${this.effects.grayscale}%)`,
                    `invert(${this.effects.invert}%)`
                ];

                // Temperatura
                if (this.effects.temperature !== 0) {
                    const tempIntensity = Math.abs(this.effects.temperature) / 2000;
                    if (this.effects.temperature > 0) filters.push(`sepia(${tempIntensity}%)`);
                    else {
                        const coolTint = tempIntensity * 0.3;
                        filters.push(`hue-rotate(${-coolTint * 15}deg)`);
                        filters.push(`saturate(${100 - coolTint * 20}%)`);
                    }
                }

                // Sharpness / Clarity / Detail
                if (this.effects.sharpness > 0) {
                    const sharpIntensity = this.effects.sharpness / 100;
                    const currentContrast = parseFloat(filters.find(f => f.includes('contrast')).match(/\d+/)[0]);
                    const currentSaturation = parseFloat(filters.find(f => f.includes('saturate')).match(/\d+/)[0]);
                    filters = filters.filter(f => !f.includes('contrast')).concat([`contrast(${Math.min(120, currentContrast + (sharpIntensity * 15))}%)`]);
                    filters = filters.filter(f => !f.includes('saturate')).concat([`saturate(${Math.min(115, currentSaturation + (sharpIntensity * 8))}%)`]);
                }
                
                // Color Grading
                if (this.effects.hsvHue !== 0) filters.push(`hue-rotate(${this.effects.hsvHue / 2}deg)`);
                
                if (this.effects.rgbRed !== 0 || this.effects.rgbGreen !== 0 || this.effects.rgbBlue !== 0) {
                     const r = Math.abs(this.effects.rgbRed)/100, g = Math.abs(this.effects.rgbGreen)/100, b = Math.abs(this.effects.rgbBlue)/100;
                     if(this.effects.rgbRed > 0) filters.push(`sepia(${r*15}%)`);
                     if(this.effects.rgbBlue !== 0) filters.push(`hue-rotate(${b*10}deg)`);
                }

                const filterString = filters.join(' ');
                youtubeBackground.style.filter = filterString;
                
                const transform = [`scale(${this.effects.scale / 100})`, `rotate(${this.effects.rotate}deg)`, `opacity(${this.effects.opacity / 100})`].join(' ');
                youtubeBackground.style.transform = transform;
                
                 if (this.effects.vignetting > 0) {
                    const vignetteIntensity = this.effects.vignetting / 100;
                    youtubeBackground.style.boxShadow = `inset 0 0 ${vignetteIntensity * 300}px rgba(0, 0, 0, ${vignetteIntensity})`;
                } else {
                    youtubeBackground.style.boxShadow = '';
                }
            }

            resetEffects() {
                this.effects = {
                    brightness: 100, contrast: 100, saturate: 100, hue: 0, blur: 0, sepia: 0, grayscale: 0, invert: 0, scale: 100, rotate: 0, opacity: 100,
                    sharpness: 0, clarity: 0, detailEnhance: 0, localContrast: 0, noiseReduction: 0, edgeEnhance: 0,
                    shadowsCold: 0, highlightsWarm: 0, vignetting: 0, background: 50, intensity: 100, ratio: 50, skinTone: 0, temperature: 0,
                    gammaMaster: 1.00, hsvHue: 0, hsvSaturation: 100, hsvValue: 100, rgbRed: 0, rgbGreen: 0, rgbBlue: 0, selectiveExposure: 0, unsharpMask: 0, chromaticAberration: 0, toneMapping: 0, dodgeBurn: 0
                };
                this.presetEffects = { grayscale: false, sepia: false, retro: false };
                this.updatePresetButton('grayscaleBtn', false);
                this.updatePresetButton('sepiaBtn', false);
                this.updatePresetButton('retroBtn', false);
                
                Object.keys(this.effects).forEach(effect => {
                    if (this.elements[effect]) {
                        this.elements[effect].value = this.effects[effect];
                        this.updateEffect(effect, this.effects[effect]);
                    }
                });
                this.showNotification('Efectos restablecidos', 'info');
            }

            saveEffects() {
                this.showNotification('Efectos aplicados al video', 'success');
                this.hideEffects();
            }

            toggleGrayscale() {
                this.presetEffects.grayscale = !this.presetEffects.grayscale;
                this.updatePresetButton('grayscaleBtn', this.presetEffects.grayscale);
                if (this.presetEffects.grayscale) {
                    this.updateEffect('grayscale', 100);
                    this.updateEffect('sepia', 0);
                    this.presetEffects.sepia = false;
                    this.updatePresetButton('sepiaBtn', false);
                } else { this.updateEffect('grayscale', 0); }
                this.applyEffects();
            }

            toggleSepia() {
                this.presetEffects.sepia = !this.presetEffects.sepia;
                this.updatePresetButton('sepiaBtn', this.presetEffects.sepia);
                if (this.presetEffects.sepia) {
                    this.effects.grayscale = 0;
                    this.updateEffect('sepia', 80);
                    this.presetEffects.grayscale = false;
                    this.updatePresetButton('grayscaleBtn', false);
                } else { this.updateEffect('sepia', 0); }
                this.applyEffects();
            }

            toggleRetro() {
                this.presetEffects.retro = !this.presetEffects.retro;
                this.updatePresetButton('retroBtn', this.presetEffects.retro);
                if (this.presetEffects.retro) {
                    this.updateEffect('sepia', 60); this.updateEffect('contrast', 120); this.updateEffect('saturate', 80); this.updateEffect('hue', 10);
                    this.presetEffects.grayscale = false; this.presetEffects.sepia = false;
                    this.updatePresetButton('grayscaleBtn', false); this.updatePresetButton('sepiaBtn', false);
                } else {
                    this.updateEffect('sepia', 0); this.updateEffect('contrast', 100); this.updateEffect('saturate', 100); this.updateEffect('hue', 0);
                }
                this.applyEffects();
            }

            applyGenrePreset(genre) {
                const genreSettings = {
                    cinematic: { brightness: 104, contrast: 112, saturate: 106, shadowsCold: 2, highlightsWarm: 4, temperature: 150, intensity: 105, sharpness: 16, clarity: 14, detailEnhance: 12, gammaMaster: 1.12, hsvHue: 3, hsvSaturation: 112, rgbRed: 2, rgbGreen: 1, rgbBlue: -1 },
                    interview: { brightness: 104, contrast: 106, saturate: 110, background: 80, skinTone: 6, temperature: 120, sharpness: 8, clarity: 10, noiseReduction: 3, gammaMaster: 1.03, rgbRed: 3 },
                    thriller: { brightness: 96, contrast: 108, saturate: 98, shadowsCold: -3, temperature: -80, sharpness: 10, localContrast: 10, noiseReduction: -1, gammaMaster: 0.95, hsvHue: -5, rgbBlue: 2, dodgeBurn: -3 },
                    drama: { brightness: 104, contrast: 108, saturate: 112, highlightsWarm: 4, temperature: 100, skinTone: 6, sharpness: 8, clarity: 10, gammaMaster: 1.02, hsvHue: 4, rgbRed: 3, rgbGreen: 2 },
                    scifi: { brightness: 98, contrast: 108, saturate: 95, shadowsCold: -4, temperature: -80, sharpness: 10, clarity: 8, localContrast: 8, gammaMaster: 0.98, hsvHue: -15, rgbBlue: 6, rgbGreen: 2, rgbRed: -3 },
                    comedy: { brightness: 106, contrast: 108, saturate: 115, highlightsWarm: 8, temperature: 150, skinTone: 8, sharpness: 12, clarity: 14, gammaMaster: 1.08, hsvHue: 8, rgbRed: 4, rgbGreen: 2 },
                    vivido: { brightness: 108, contrast: 110, saturate: 120, highlightsWarm: 10, temperature: 200, skinTone: 10, sharpness: 14, clarity: 15, gammaMaster: 1.05, hsvHue: 12, rgbRed: 8, rgbGreen: 5 },
                    pixelHDR: { brightness: 108, contrast: 112, saturate: 118, highlightsWarm: 10, temperature: 120, skinTone: 12, sharpness: 16, clarity: 15, gammaMaster: 1.02, hsvHue: 10, rgbRed: 6, rgbGreen: 4 },
                    terror: { brightness: 93, contrast: 110, saturate: 90, shadowsCold: -5, temperature: -120, sharpness: 8, localContrast: 12, gammaMaster: 0.90, hsvHue: -15, rgbBlue: 6, rgbRed: -3, dodgeBurn: -8 }
                };

                const settings = genreSettings[genre];
                if (!settings) return;

                this.resetEffects();
                Object.keys(settings).forEach(setting => {
                    if (this.effects.hasOwnProperty(setting)) {
                        this.updateEffect(setting, settings[setting]);
                        if (this.elements[setting]) this.elements[setting].value = settings[setting];
                    }
                });
                
                this.applyEffects();
                const genreNames = { cinematic: 'üé¨ Cinematogr√°fico', interview: 'üéôÔ∏è Entrevistas', thriller: 'üïµÔ∏è Thriller', drama: 'üíî Drama', scifi: 'üöÄ Sci-Fi', comedy: 'üòÇ Comedia', vivido: 'üåü Vivido', pixelHDR: 'üöÄ Pixel HDR', terror: 'üåô Terror' };
                this.showNotification(`${genreNames[genre]} - Todos los par√°metros actualizados`, 'success');
            }

            updatePresetButton(buttonId, isActive) {
                const button = this.elements[buttonId];
                if (button) isActive ? button.classList.add('active') : button.classList.remove('active');
            }

            parseTime(timeString) {
                if (!timeString || timeString === '--:--') return 0;
                timeString = timeString.trim();
                if (timeString.includes(':')) {
                    const parts = timeString.split(':');
                    return (parseInt(parts[0]) || 0) * 60 + (parseInt(parts[1]) || 0);
                }
                return parseInt(timeString) || 0;
            }

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            updateRangeDisplay() {
                // Funci√≥n mantenida para compatibilidad
                const rangeText = `Rango: ${this.elements.startTime.value || '0:00'} ‚Üí ${this.elements.endTime.value || '--:--'}`;
                this.elements.videoRange.textContent = rangeText;
            }

            getEstimatedCurrentTime() {
                const progressPercent = parseFloat(this.elements.progressBarFill.style.width) || 0;
                return this.startTime + (progressPercent / 100) * (this.endTime - this.startTime);
            }

            showNotification(message, type = 'info') {
                const notification = this.elements.notification;
                notification.textContent = message;
                notification.className = `notification show`;
                setTimeout(() => { notification.classList.remove('show'); }, 3000);
            }

            handleKeyboard(event) {
                switch(event.code) {
                    case 'Space': event.preventDefault(); this.playPause(); break;
                    case 'KeyF': event.preventDefault(); this.toggleFullscreen(); break;
                    case 'KeyC': event.preventDefault(); this.showConfig(); break;
                    case 'KeyE': event.preventDefault(); this.showEffects(); break;
                    case 'Escape': 
                        if (document.fullscreenElement) document.exitFullscreen();
                        this.hideConfig(); this.hideEffects(); break;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.overlayPlayer = new YouTubeOverlayPlayer();
            document.addEventListener('fullscreenchange', () => {
                if (window.overlayPlayer && !document.fullscreenElement) {
                    window.overlayPlayer.showAllControls();
                }
            });
        });
    </script>
</body>
</html>
